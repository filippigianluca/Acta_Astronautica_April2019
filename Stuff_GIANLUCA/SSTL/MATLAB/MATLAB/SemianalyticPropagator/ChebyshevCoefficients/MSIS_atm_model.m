function [rho, H, h0, rho0, step] = MSIS_atm_model (h)

% Compute the atmospheric density 
% Input:  h -> spacecraft height [km]
% Output: rho -> atmospheric density [kg/m^3]
% Reference: 

% Marilena Di Carlo, 2015#

% Distance unit DU - Earth Radius [km]
DU = 6378.136;

% Time unit TU [s]
TU = 806.78;

h = h * DU;

%         [h_ellp,     h0,  rho0], 
% table  = [ 0      50    0  1.165       ; ...
%            50    100   50  1.122e-3    ; ...
%           100    150  100  5.581e-7    ; ...
%           150    200  150  1.894e-9   ; ...
%           200    250  200  2.900e-10  ; ...
%           250    300  250  7.545e-11  ; ...
%           300    350  300  2.412e-11  ; ...
%           350    400  350  8.684e-12  ; ...
%           400    450  400  3.366e-12  ; ...
%           450    500  450  1.371e-12  ; ...
%           500    550  500  5.799e-13  ; ...
%           550    600  550  2.542e-13  ; ...
%           600    650  600  1.161e-13  ; ...
%           650    700  650  5.593e-14  ; ...
%           700    750  700  2.892e-14  ; ...
%           750    800  750  1.632e-14  ; ...
%           800    850  800  1.013e-14  ; ...
%           850    900  850  6.869e-15  ; ...
%           900   950   900  5.010e-15  ; ...
%           950   1000  950  3.850e-15  ; ...
%          1000   1e5  1000  3.064e-15  ];
     
     %MSISe-90 (Klinkrad low solar activity)
%      table  = [ 100      125    100  6.57e-7       ; ...
%            125    150   125  9.79e-9    ; ...
%           150    175  150  1.57e-9    ; ...
%           175    200  175  4.68e-10   ; ...
%           200    225  200  1.74e-10  ; ...
%           225    250  225  7.29e-11  ; ...
%           250    275  250  3.31e-11  ; ...
%           275    300  275  1.60e-11  ; ...
%           300    325  300  8.10e-12  ; ...
%           325    350  325  4.27e-12  ; ...
%           350    375  350  2.32e-12  ; ...
%           375    400  375  1.29e-12  ; ...
%           400    425  400  7.30e-13  ; ...
%           425    450  425  4.19e-13  ; ...
%           450    475  450  2.45e-13  ; ...
%           475    500  475  1.45e-13  ; ...
%           500    525  500  8.74e-14  ; ...
%           525    550  525  5.38e-14  ; ...
%           550   575   550  3.39e-14  ; ...
%           575   600  575  2.21e-14  ; ...
%           600   625  600  1.49e-14  ; ...
%           625    650  625  1.05e-14  ; ...
%           650    675  650  7.64e-15  ; ...
%           675    700  675  5.82e-15  ; ...
%           700   1e5   700  4.59e-15        
%             ];
%         
%              %MSISe-90 (Klinkrad standard solar activity)
%      table  = [ 100      125    100  5.80e-7       ; ...
%            125    150   125  1.01e-8    ; ...
%           150    175  150  1.79e-9    ; ...
%           175    200  175  6.20e-10   ; ...
%           200    225  200  2.75e-10  ; ...
%           225    250  225  1.39e-10  ; ...
%           250    275  250  7.58e-11  ; ...
%           275    300  275  4.36e-11  ; ...
%           300    325  300  2.60e-11  ; ...
%           325    350  325  1.61e-11  ; ...
%           350    375  350  1.02e-11  ; ...
%           375    400  375  6.55e-12  ; ...
%           400    425  400  4.29e-12  ; ...
%           425    450  425  2.85e-12  ; ...
%           450    475  450  1.91e-12  ; ...
%           475    500  475  1.30e-12  ; ...
%           500    525  500  8.86e-13  ; ...
%           525    550  525  6.10e-13  ; ...
%           550   575   550  4.23e-13  ; ...
%           575   600  575   2.95e-13  ; ...
%           600   625  600   2.08e-13  ; ...
%           625    650  625  1.47e-13  ; ...
%           650    675  650  1.05e-13  ; ...
%           675    700  675  7.59e-14  ; ...
%           700   1e5   700  5.53e-14        
%             ];
      
%     MSISe-90 (Klinkrad high solar activity)
     table  = [ 100      125    100  3.02e-7       ; ...
           125    150   125  1.18e-8    ; ...
          150    175  150  2.72e-9    ; ...
          175    200  175  1.24e-9   ; ...
          200    225  200  7.27e-10  ; ...
          225    250  225  4.75e-10  ; ...
          250    275  250  3.28e-10  ; ...
          275    300  275  2.34e-10  ; ...
          300    325  300  1.70e-10  ; ...
          325    350  325  1.26e-10  ; ...
          350    375  350  9.46e-11  ; ...
          375    400  375  7.16e-11  ; ...
          400    425  400  5.48e-11  ; ...
          425    450  425  4.22e-11  ; ...
          450    475  450  3.27e-11  ; ...
          475    500  475  2.55e-11  ; ...
          500    525  500  2.00e-11  ; ...
          525    550  525  1.57e-11  ; ...
          550   575   550  1.24e-11  ; ...
          575   600  575   9.88e-12  ; ...
          600   625  600   7.87e-12  ; ...
          625    650  625  6.29e-12  ; ...
          650    675  650  5.04e-12  ; ...
          675    700  675  4.05e-12  ; ...
          700   1e5   700  3.27e-12        
            ];
        
for i = 1 : length(table)-1
   H(i) =  ( table(i,1) - table(i,2) ) / log(table(i+1,4)/table(i,4));
end


table(1:end-1,5) = H';

% Last scale height value - from Vallado, Table 7.4. Computed considering
% rho(i+1) at 2500 km and the corresponding density
table(end,5) = 143;
     
for i = 1 : length(table)

    if h>= table(i,1)  && h <= table(i,2)
        index = i;
        break
    end
    
end

if h > table(end,1)
    index = size(table,1);
end

if ~exist('index')
    keyboard
end

h0   = table(index,3);
rho0 = table(index,4);
H    = table(index,5);

rho = rho0 * exp(-(h - h0)/H) ;
rho = (rho / 1e-9) * DU^3 ;

end