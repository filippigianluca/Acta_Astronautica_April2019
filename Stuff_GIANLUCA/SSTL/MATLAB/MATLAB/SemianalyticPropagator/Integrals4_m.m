function [I] = Integrals4_m(L0, L, P10, P20, t_flag, In_flag, J2_flag, e_flag)


% Calculates analytical integrals for the perturbative expansion.
%
% INPUTS:
% L0: longitude of the initial state.
% L: longitude of the current state.
% P10: initial equinoctial element P1.
% P20: initial equinoctial element P2.
% t_flag: in t
% In_flag: 1 if constant inertial acceleration is considered.
% J2_flag: 1 if J2 perturbation is considered.
% e_flag: 1 if initial eccentricity is not zero
%
% OUTPUTS:
% I: 6-row vector with the integrals between x(1) and x(2).

% Reference: Zuiani, "Extended Analytical Formulas for the Perturbed
% Keplerian Motion Under a Constant Control Acceleration"

% Author: Federico Zuiani
% Comments and code tidying: Marilena Di Carlo

%% Initialization

% If only four input are defined (L0, L, P10, P20), set the flag variables
% to 1
if nargin < 5
    t_flag  = 1;
    In_flag = 1;
    J2_flag = 1;
end

% Compute difference between L and L0
DL = mod(L+pi, 2*pi) - mod(L0+pi, 2*pi);

if (DL <= 0) && (mod(L+pi,2*pi)==0) && (L~=L0)
    DL = DL + 2*pi;
end

% Useful precomputation
sL  = sin(L);
sL0 = sin(L0);
cL  = cos(L);
cL0 = cos(L0);

% Useful for the analytical terms of the integrals of J2
s2L  = sin(2*L);
s2L0 = sin(2*L0);
c2L  = cos(2*L);
c2L0 = cos(2*L0);

s3L  = sin(3*L);
s3L0 = sin(3*L0);
c3L  = cos(3*L);
c3L0 = cos(3*L0);

s4L  = sin(4*L);
s4L0 = sin(4*L0);

s5L  = sin(5*L);
s5L0 = sin(5*L0);
c5L  = cos(5*L);
c5L0 = cos(5*L0);


if J2_flag || In_flag
    
    % Useful precomputation for the terms of the analytical integrals of J2
    % The number reported in the following refer to the position in the
    % final vector I' which includes also the analytical integrals for the
    % tangent case.
    % I'(4)
    IJc1 = sL - sL0;
    % I'(5)
    IJs1 = cL0 - cL;
    % I'(6)
    IJc2   = 0.5*(L - L0) + 0.25*(s2L-s2L0);
    % I'(7)
    IJc1s1 = -0.5*(cL^2-cL0^2);
    % I'(8)
    IJs2   = 0.5*(L - L0) - 0.25*(s2L - s2L0);
    % I'(9)
    IJc3   = 0.75*(sL-sL0) + 1/12*(s3L-s3L0);
    % I'(10)
    IJc2s1 = -(cL^3 - cL0^3)/3;
    % I'(11)
    IJc1s2 = (sL^3 - sL0^3)/3;
    % I'(12)
    IJs3   = -0.75*(cL-cL0) + 1/12*(c3L-c3L0);
    % I'(13)
    IJc4   = 3/8*(L-L0) + 0.25*(s2L-s2L0) + 1/32*(s4L-s4L0); 
    % I'(14)
    IJc3s1 = -(cL^4 - cL0^4)/4;
    % I'(15)
    IJc2s2 = (L - L0)/8 - (s4L - s4L0)/32;
    % I'(16)
    IJc1s3 = (sL^4 - sL0^4)/4;
    % I'(17)
    IJs4   = 3/8*(L-L0)-0.25*(s2L-s2L0) + 1/32*(s4L-s4L0);  
    % I'(18)
    IJc5   = 5/8*(sL-sL0) + 5/48*(s3L-s3L0) + 1/80*(s5L-s5L0);
    % I'(19)
    IJc4s1 = -(cL^5 - cL0^5)/5;
    % I'(20)
    IJc3s2 = 1/8*(sL-sL0) - 1/48*(s3L-s3L0) - 1/80*(s5L-s5L0);
    % I'(21)
    IJc2s3 = -1/8*(cL-cL0) - 1/48*(c3L-c3L0) + 1/80*(c5L-c5L0);
    % I'(22)
    IJc1s4 = (sL^5 - sL0^5)/5;
    % I'(23)
    IJs5   = -5/8*(cL-cL0) + 5/48*(c3L-c3L0) - 1/80*(c5L-c5L0);
else
    IJc1=0;
    IJs1=0;
    IJc2=0;
    IJc1s1=0;
    IJs2=0;
    IJc3=0;
    IJc2s1=0;
    IJc1s2=0;
    IJs3=0;
    IJc4=0;
    IJc3s1=0;
    IJc2s2=0;
    IJc1s3=0;
    IJs4=0;
    IJc5=0;
    IJc4s1=0;
    IJc3s2=0;
    IJc2s3=0;
    IJc1s4=0;
    IJs5=0;
end


% If initial eccentircity is zero:
if ~e_flag
    
    % In this case, Phi = 1 + P1 sinL + P2 cosL = 1
    % I11, I12 and I13 have integrands equal to 1
    I12 = L-L0;
    I13 = I12;
    
    % The integrand of Ic2 is cos L
    Ic2 = sL-sL0;
    
    % The integrand of Is2 is sin L
    Is2 = cL0-cL;
    
    Ic3 = Ic2;
    Is3 = Is2;
    
    % If J2 perturbation are considered of if constant intertial
    % acceleration is considered
    if J2_flag||In_flag
        Icc3 = IJc2;
        Ics3 = IJc1s1;
        Iss3 = IJs2;
        I3c3 = IJc3;
        I2c1s3 = IJc2s1;
        I1c2s3 = IJc1s2;
        I3s3 = IJs3;
        I4c3 = IJc4;
        I3c1s3 = IJc3s1;
        I2c2s3 = IJc2s2;
        I1c3s3 = IJc1s3;
        I4s3 = IJs4;
    else
        Icc3=0;
        Ics3=0;
        Iss3=0;
        I3c3=0;
        I2c1s3=0;
        I1c2s3=0;
        I3s3=0;
        I4c3=0;
        I3c1s3=0;
        I2c2s3=0;
        I1c3s3=0;
        I4s3=0;
    end
    
    
    if t_flag
        I11=I12;
        LL=mod(L+pi,2*pi)-pi;
        LL0=mod(L0+pi,2*pi)-pi;
        Ia2=(LL^2-LL0^2)/4 - (LL*atan(tan(LL/2))-LL0*atan(tan(LL0/2)));
    else
        I11=0;
        Ia2=0;
    end
    
% Previous case does not apply, therefore eccentricity is not zero. However
% 1/P20 is very big, meaning that cos(Omega+omega) = 0 and therefore that
% (Omega + omega) = 90. Therefore P20 can be neglected from the equations
elseif (abs(1/P20)>1e13)
    
    H1 = sqrt(1 - P10^2);
    H3 = H1^3;
    H5 = H1^5;
    
    K  = atan((P10 + tan(L/2))/H1);
    K0 = atan((P10 + tan(L0/2))/H1);
    K1 =(K - K0);
    
    M1 = (1 + P10*sL);
    M2 = M1^2;
    M10 = (1 + P10*sL0);
    M20 = M10^2;
    
    I12 = (2*K1 + (P10*H1*(cL/M1 - cL0/M10)))/H3;
    I13 = 1/(2*(1 - P10^2)^2)*((2*(2 + P10^2)*K1)/H1 + P10*(cL*(4 - P10^2 + 3*P10*sL)/M2 - cL0*(4 - P10^2 + 3*P10*sL0)/M20));
    
    Ic2 = -(1/M1-1/M10)/P10;
    Is2 = -((cL/M1 - cL0/M10)/(1 - P10^2) + 2*P10*K1/H3);
    Ic3 = 1/(2*P10)*(-1/M2+1/M20);
    Is3 = 1/(2*H5)*(-6*P10*K1 - H1*(cL*(2 + P10^2 + (P10 + 2*P10^3)*sL)/M2 - cL0*(2 + P10^2 + (P10 + 2*P10^3)*sL0)/M20));
    
    if J2_flag||In_flag
        
        N1=log(M1/M10);
        Icc3 = -(((-H1)*(cL*(P10 + sL)/M2 - cL0*(P10 + sL0)/M20) - 2*K1)/(2*H3));
        Ics3 = -((1 + 2*P10*sL)/M2-(1 + 2*P10*sL0)/M20)/(2*P10^2);
        Iss3 =(2*(1 + 2*P10^2)*K1/H1 + (cL*(3*P10 + (-1 + 4*P10^2)*sL))/M2 - (cL0*(3*P10 + (-1 + 4*P10^2)*sL0))/M20)/(2*(-1 + P10^2)^2);
        I3c3=-((2*N1 + (3 + P10^2)*(1/M1^2-1/M10^2) + 4*P10*(sL/M1^2-sL0/M10^2))/(2*P10^3));
        I2c1s3=-((2*(-2 + 3*P10^2)*K1/H3 +...
            (-2*DL*(-1 + P10^2) - P10*((1 - P10^2)*(cL/M1^2-cL0/M10^2) + (-3 + 2*P10^2)*(cL/M1-cL0/M10)))/(1 - P10^2))/(2*P10^3));
        I1c2s3=(2*N1 + (3*(1/M1^2-1/M10^2) + 4*P10*(sL/M1^2-sL0/M10^2)))/(2*P10^3);
        I3s3=(2*DL - (2*(2 - 5*P10^2 + 6*P10^4)*K1)/H5 + (P10*((- 1 + P10^2)*(cL/M1^2-cL0/M10^2) + 3*(1 - 2*P10^2)*(cL/M1-cL0/M10)))/(-1 + P10^2)^2)/(2*P10^3);
        I4c3=-((6*DL + (6*(-2 + P10^2)*K1)/H1 + (P10*((-3 + P10^2)*(cL/M1^2-cL0/M10^2) + 9*(cL/M1-cL0/M10) + 2*P10^2*(cL*sL^2/M1^2-cL0*sL0^2/M10^2))))/(2*P10^4));
        I3c1s3=-((-6*N1 + 2*P10*(sL-sL0) + ((-5 + P10^2)*(1/M1^2-1/M10^2) + 2*P10*(-3 + P10^2)*(sL/M1^2-sL0/M10^2)))/(2*P10^4));
        I2c2s3=(6*DL - (2*(6 - 9*P10^2 + 2*P10^4)*K1)/H3 + 2*P10*(cL-cL0) - P10*(cL/M1^2-cL0/M10^2) +...
            P10*(-5 + 4*P10^2)*(cL/M1-cL0/M10)/(-1 + P10^2))/(2*P10^4);
        I1c3s3=-((6*N1 - 2*P10*(sL-sL0) + (-(1/M1^2-1/M10^2) + 6*(1/M1-1/M10)))/(2*P10^4));
        I4s3=(-6*DL + (6*(2 - 5*P10^2 + 4*P10^4)*K1)/H5 +...
            P10*(-2*(cL-cL0) - (cL/M1^2-cL0/M10^2)/(-1 + P10^2) + (-5 + 8*P10^2)*(cL/M1-cL0/M10)/(-1 + P10^2)^2)...
            )/(2*P10^4);
    else
        Icc3=0;
        Ics3=0;
        Iss3=0;
        I3c3=0;
        I2c1s3=0;
        I1c2s3=0;
        I3s3=0;
        I4c3=0;
        I3c1s3=0;
        I2c2s3=0;
        I1c3s3=0;
        I4s3=0;
    end
    
    if t_flag
        I11=2*K1/H1;
        Ia2=-(2*(K^2-K0^2) + 2*P10*(H1*(K*cos(2*K)-K0*cos(2*K0)) + P10*(K*sin(2*K)-K0*sin(2*K0))) + P10*(P10*(cos(2*K)-cos(2*K0)) - H1*(sin(2*K)-sin(2*K0))))/(2*H3);
    else
        I11=0;
        Ia2=0;
    end
    
% If e~=0 and P2~=0    
else
    
    H0 = (-1 + P10^2 + P20^2);
    H1 = sqrt(-H0);
    H3 = H1^3;
    H5 = H1^5;
    
    M1 = (1 + P20*cL + P10*sL);
    M2 = M1.^2;
    M10 = (1 + P20*cL0 + P10*sL0);
    M20 = M10^2;
    
    K = atan((-P10 + (-1 + P20)*tan(L/2))/(H1));
    K0 = atan((-P10 + (-1 + P20)*tan(L0/2))/(H1));
    K1 = (K - K0);
    
    % ---------------------------------------------------------------------
    % Commented by Federico:
    %     S=(P10 + sL);
    %     R=(P10*(3*M1-H0)+sL*(3*M1+2*M1*H0-H0));
    %     S0=(P10 + sL0);
    %     R0=(P10*(3*M10-H0)+sL0*(3*M10+2*M10*H0-H0));
    % ---------------------------------------------------------------------

    I12 = -2/H3*K1 + 1/(P20*H0)*((P10 + (P10^2 + P20^2)*sL)/(M1)-(P10 + (P10^2 + P20^2)*sL0)/(M10));
    
    I13 = (1/2)*(-2*(2 + P10^2 + P20^2)/H5*K1...
        + 1/(P20*H0)*(((P10 + (P10^2 + P20^2)*sL)/M2 - (P10*(2 + P10^2 + P20^2) + 3*(P10^2 + P20^2)*sL)/(H0*M1)) - ((P10 + (P10^2 + P20^2)*sL0)/M20 - (P10*(2 + P10^2 + P20^2) + 3*(P10^2 + P20^2)*sL0)/(H0*M10))));
    % ---------------------------------------------------------------------
    % Commented by Federico:
    %         + 1/P20/H0^2*((-R+sL*H0*(H0-M1))/M2-(-R0+sL0*H0*(H0-M10))/M20)-P10/P20/H0^2);
    % ---------------------------------------------------------------------
    
    Ic2 = (2*P20*K1/H3) - ((P10 + sL)/M1 - (P10 + sL0)/M10)/H0;
    % ---------------------------------------------------------------------
    % Commented by Federico:
    %     (S/M1-S0/M10)/H0;
    % ---------------------------------------------------------------------
    
    Is2=(2*P10*K1/H3) + ((-1 + P20^2 - P10*sL)/M1 - (-1 + P20^2 - P10*sL0)/M10)/(P20*H0);
    % ---------------------------------------------------------------------
    % Commented by Federico:
    %     ((1 - P10*S/H0)/M1 - (1 - P10*S0/H0)/M10)/P20;
    % ---------------------------------------------------------------------
    
    Ic3 = (1/2)*((6*P20/H5*K1)...
        + 1/H0*((- (P10 + sL)/(M2) + (3*P10 + (1 + 2*P10^2 + 2*P20^2)*sL)/(H0*M1)) -...
        (- (P10 + sL0)/(M20) + (3*P10 + (1 + 2*P10^2 + 2*P20^2)*sL0)/(H0*M10))));
    % ---------------------------------------------------------------------
    % Commented by Federico:
    %     + (R/M2-R0/M20)/H0^2);
    % ---------------------------------------------------------------------
    
    Is3 = (1/2)*((6*P10/H5*K1)...
        + 1/(P20*H0)*(((-1 + P20^2 - P10*sL)/M2 + (P10*(3*P10 + (1 + 2*P10^2 + 2*P20^2)*sL))/(H0*M1)) -...
        ((-1 + P20^2 - P10*sL0)/M20 + (P10*(3*P10 + (1 + 2*P10^2 + 2*P20^2)*sL0))/(H0*M10))));
    
    if J2_flag||In_flag
        N1=log(M1/M10);
        
        Icc3=(-1 + P10^2 - 2*P20^2)*K1/H5 -...
            ((P10*(2 - P10^2 - P10^4 - P20^2 + 7*P10^2*P20^2 + 8*P20^4) + 2*P10*P20*(2 + P10^4 - 3*P20^2 + 4*P20^4 + P10^2*(-3 + 5*P20^2))*cL +...
            P10*(P10^4 + P20^2 - 4*P20^4 - P10^2*(1 + 3*P20^2))*c2L + (4*P10^2 - 4*P10^4 + 2*P10^2*P20^2 + 6*P10^4*P20^2 + 6*P20^4 + 6*P10^2*P20^4)*sL +...
            P20*(P10^2 - P10^4 - P20^2 + 3*P10^2*P20^2 + 4*P20^4)*s2L)/M2 -...
            (P10*(2 - P10^2 - P10^4 - P20^2 + 7*P10^2*P20^2 + 8*P20^4) + 2*P10*P20*(2 + P10^4 - 3*P20^2 + 4*P20^4 + P10^2*(-3 + 5*P20^2))*cL0 +...
            P10*(P10^4 + P20^2 - 4*P20^4 - P10^2*(1 + 3*P20^2))*c2L0 + (4*P10^2 - 4*P10^4 + 2*P10^2*P20^2 + 6*P10^4*P20^2 + 6*P20^4 + 6*P10^2*P20^4)*sL0 +...
            P20*(P10^2 - P10^4 - P20^2 + 3*P10^2*P20^2 + 4*P20^4)*s2L0)/M20)/...
            (4*P20*H0^2*(P10^2 + P20^2));
        % ---------------------------------------------------------------------
        % Commented by Federico:
        %         Icc3=(-1 + P10^2 - 2*P20^2)*K1/H5-((M1*(P10*(2 - 3*P10^2 + P10^4 + (-3 + 5*P10^2)*P20^2 + 4*P20^4) + (P10^2 - P10^4 - P20^2 + 3*P10^2*P20^2 + 4*P20^4)*sL) -...
        %             H0*(P10*(-1 + P10^2 + 2*P20^2) + (P20^2 + P10^2*H0)*sL))/M2-...
        %             (M10*(P10*(2 - 3*P10^2 + P10^4 + (-3 + 5*P10^2)*P20^2 + 4*P20^4) + (P10^2 - P10^4 - P20^2 + 3*P10^2*P20^2 + 4*P20^4)*sL0) -...
        %             H0*(P10*(-1 + P10^2 + 2*P20^2) + (P20^2 + P10^2*H0)*sL0))/M20...
        %             )/(2*P20*H0^2*(P10^2 + P20^2));
        % ---------------------------------------------------------------------
        
        Ics3=(1/2)*(-((6*P10*P20*K1)/H5) +...
            ((-(-1 + P20^2 + P10*(-2 + P10^2 + P20^2)*sL)/M1 +...
            (-P10^4 + P10^2*(-4 + P20^2) + 2*(-1 + P20^2)^2 - P10*(-2 + 5*P10^2 + 5*P20^2)*sL)/H0)/M1-...
            (-(-1 + P20^2 + P10*(-2 + P10^2 + P20^2)*sL0)/M10 +...
            (-P10^4 + P10^2*(-4 + P20^2) + 2*(-1 + P20^2)^2 - P10*(-2 + 5*P10^2 + 5*P20^2)*sL0)/H0)/M10)/(H0*(P10^2 + P20^2)));
        
        Iss3=-(((1 + 2*P10^2 - P20^2)*K1)/H5) +...
            ((2*P10 - 7*P10^3 - 4*P10^5 - 7*P10*P20^2 + P10^3*P20^2 + 5*P10*P20^4 + 2*P10*P20*(2 - 5*P20^2 + 3*P20^4 + P10^2*(-5 + 3*P20^2))*cL +...
            P10*(4*P10^4 + P20^2 - P20^4 + P10^2*(-1 + 3*P20^2))*c2L + 4*P10^2*sL - 16*P10^4*sL - 18*P10^2*P20^2*sL + 8*P10^4*P20^2*sL - 2*P20^4*sL +...
            10*P10^2*P20^4*sL + 2*P20^6*sL + P10^2*P20*s2L - 4*P10^4*P20*s2L - P20^3*s2L - 3*P10^2*P20^3*s2L + P20^5*s2L)/M2 -...
            (2*P10 - 7*P10^3 - 4*P10^5 - 7*P10*P20^2 + P10^3*P20^2 + 5*P10*P20^4 + 2*P10*P20*(2 - 5*P20^2 + 3*P20^4 + P10^2*(-5 + 3*P20^2))*cL0 +...
            P10*(4*P10^4 + P20^2 - P20^4 + P10^2*(-1 + 3*P20^2))*c2L0 + 4*P10^2*sL0 - 16*P10^4*sL0 - 18*P10^2*P20^2*sL0 + 8*P10^4*P20^2*sL0 - 2*P20^4*sL0 +...
            10*P10^2*P20^4*sL0 + 2*P20^6*sL0 + P10^2*P20*s2L0 - 4*P10^4*P20*s2L0 - P20^3*s2L0 - 3*P10^2*P20^3*s2L0 + P20^5*s2L0)/M20)/...
            (4*P20*H0^2*(P10^2 + P20^2));
        
        I3c3=(1/(2*(P10^2 + P20^2)^3))*(2*DL*P20*(-3*P10^2 + P20^2) +...
            2*P20*(-9*P10^6 + 3*P10^4*(5 - 4*P20^2) + P10^2*(-6 + 10*P20^2 + 3*P20^4) + P20^2*(2 - 5*P20^2 + 6*P20^4))*K1/H5 - 2*P10*(P10^2 - 3*P20^2)*N1 +...
            (P10^2 + P20^2)/H0^2*(P10*(8 - 13*P10^2 + 5*P10^4 + 17*(-1 + P10^2)*P20^2 + 12*P20^4)*(1/M1-1/M10) +...
            3*(P10^2*(3 - 5*P10^2 + 2*P10^4) + (-1 - 3*P10^2 + 4*P10^4)*P20^2 + 2*(1 + P10^2)*P20^4)*(sL/M1-sL0/M10)) -...
            (P10^2 + P20^2)/H0*(P10*(-2 + P10^2 + P10^4 + (3 + P10^2)*P20^2)*(1/M1^2-1/M10^2) +...
            (P20^2 + 3*P10^2*H0)*(sL/M1^2-sL0/M10^2)));
        
        I2c1s3=(1/(2*(P10^2 + P20^2)^3))*(-2*DL*P10*(P10^2 - 3*P20^2) +...
            2*P10*(-2*P10^2 + 5*P10^4 - 3*P10^6 + 2*(3 - 5*P10^2 + 3*P10^4)*P20^2 + 3*(-5 + 7*P10^2)*P20^4 + 12*P20^6)*K1/H5 +...
            (6*P10^2*P20 - 2*P20^3)*N1 + ((-1 + P20^2)*(P10^2 + P20^2)*(P10^4 + P20^2 + P10^2*(-1 + P20^2))*(1/M1^2-1/M10^2) +...
            P10*(P10^4 - P10^6 + P20^4*(-3 + 2*P20^2) + P10^2*P20^2*(-2 + 3*P20^2))*(sL/M1^2-sL0/M10^2))/(P20*H0) +...
            (P10^2 + P20^2)/(P20*H0^2)*((3*P10^6 - 4*P20^2*(-1 + P20^2)^2 + P10^4*(-7 + 9*P20^2) + P10^2*(4 - 3*P20^2 + 2*P20^4))*(1/M1-1/M10) +...
            P10*(-5*P10^4 + 2*P10^6 - 9*P20^2 + 16*P20^4 - 4*P20^6 + P10^2*(3 + 11*P20^2 - 6*P20^4))*(sL/M1-sL0/M10)));
        
        I1c2s3=(1/(2*(P10^2 + P20^2)^3))*(2*DL*P20*(3*P10^2 - P20^2) +...
            2*P20*(12*P10^6 - 2*P20^2 + 5*P20^4 - 3*P20^6 + 3*P10^4*(-5 + 7*P20^2) + 2*P10^2*(3 - 5*P20^2 + 3*P20^4))*K1/H5 +...
            2*P10*(P10^2 - 3*P20^2)*N1 - (P10^2 + P20^2)/H0^2*(P10*(8 - 13*P10^2 + 2*P10^4 + (-17 + 11*P10^2)*P20^2 + 9*P20^4)*(1/M1-1/M10) +...
            (P10^2*(9 - 16*P10^2 + 4*P10^4) + (-3 - 11*P10^2 + 6*P10^4)*P20^2 + 5*P20^4 - 2*P20^6)*(sL/M1-sL0/M10)) +...
            (P10^2 + P20^2)/H0*((-P10)*(-1 + P20^2)*(-2 + P10^2 + P20^2)*(1/M1^2-1/M10^2) +...
            (2*P10^4 + P20^2 - P20^4 + P10^2*(-3 + P20^2))*(sL/M1^2-sL0/M10^2)));
        
        I3s3=(1/(2*(P10^2 + P20^2)^3))*(2*DL*P10*(P10^2 - 3*P20^2) +...
            2*P10*(6*P10^6 - 6*P20^2 + 15*P20^4 - 9*P20^6 + P10^4*(-5 + 3*P20^2) + 2*P10^2*(1 + 5*P20^2 - 6*P20^4))*K1/H5 + 2*P20*(-3*P10^2 + P20^2)*N1 +...
            (P10^2 + P20^2)/(P20*H0)*((-P10^2 + P20^2 + (-2 + P10^2)*P20^4 + P20^6)*(1/M1^2-1/M10^2) -...
            P10*(P10^2 + 3*(-1 + P10^2)*P20^2 + 3*P20^4)*(sL/M1^2-sL0/M10^2)) +...
            (P10^2 + P20^2)/(P20*H0^2)*((P10^4*(7 - 3*P20^2) + 4*P20^2*(-1 + P20^2)^2 + P10^2*(-4 + 3*P20^2 + P20^4))*(1/M1-1/M10) +...
            3*P10*(3*P20^2 - 5*P20^4 + 2*P20^6 + 2*P10^4*(1 + P20^2) + P10^2*(-1 - 3*P20^2 + 4*P20^4))*(sL/M1-sL0/M10)));
        
        I4c3=-((1/(2*(P10^2 + P20^2)^4))*(6*DL*(P10^4 - 6*P10^2*P20^2 + P20^4) -...
            6*(P10^4*(-2 + P10^2)*(-1 + P10^2)^2 - P10^2*(-12 + P10^2)*(-1 + P10^2)^2*P20^2 - (2 + 25*P10^2 - 36*P10^4 + 9*P10^6)*P20^4 + (5 + 14*P10^2 - 11*P10^4)*P20^6 - 4*(1 + P10^2)*P20^8)*K1/H5 +...
            2*P10*(P10^2 - 3*P20^2)*(P10^2 + P20^2)*(cL-cL0) + 24*P10*P20*(-P10^2 + P20^2)*N1 - 2*P20*(-3*P10^4 - 2*P10^2*P20^2 + P20^4)*(sL-sL0) -...
            (P10^2 + P20^2)/(P20*H0)*((P10^3*(-1 + P10^2)^2 + P10*(-3 - 2*P10^2 + 5*P10^4)*P20^2 + 4*P10*(1 + P10^2)*P20^4)*(1/M1^2-1/M10^2) +...
            (P10^4*(-1 + P10^2)^2 + 2*P10^2*(-3 + 2*P10^2 + P10^4)*P20^2 + (1 + 6*P10^2 + P10^4)*P20^4)*(sL/M1^2-sL0/M10^2)) +...
            (P10^2 + P20^2)/(P20*H0^2)*((P10*(P10^2*(-6 + P10^2)*(-1 + P10^2)^2 + 2*(9 - 5*P10^2 - 9*P10^4 + 5*P10^6)*P20^2 + (-39 + 14*P10^2 + 17*P10^4)*P20^4 + 8*(3 + P10^2)*P20^6))*(1/M1-1/M10) +...
            (-5*P10^4*(-1 + P10^2)^2 + 2*P10^2*(15 - 22*P10^2 + 7*P10^4)*P20^2 + (-5 - 46*P10^2 + 43*P10^4)*P20^4 + 8*(1 + 3*P10^2)*P20^6)*(sL/M1-sL0/M10))));
        
        I3c1s3=-((1/(2*(P10^2 + P20^2)^4))*(24*DL*P10*P20*(-P10^2 + P20^2) +...
            6*P10*P20*(3*P10^8 + 8*P20^2 - 20*P20^4 + 15*P20^6 - 2*P20^8 + P10^6*(-15 + 7*P20^2) + P10^2*(-8 + 15*P20^4 - 3*P20^6) + P10^4*(20 + 3*P20^2*(-5 + P20^2)))*K1/H5 +...
            2*P20*(-3*P10^4 - 2*P10^2*P20^2 + P20^4)*(cL-cL0) - 6*(P10^4 - 6*P10^2*P20^2 + P20^4)*N1 + 2*P10*(P10^2 - 3*P20^2)*(P10^2 + P20^2)*(sL-sL0) +...
            ((-1 + P20^2)*(P10^2 + P20^2)*(P20^2 + 3*P10^2*H0)*(1/M1^2-1/M10^2) +...
            P10*(P10^4*(4 - 5*P10^2 + P10^4) + P10^4*(-7 + 3*P10^2)*P20^2 + (-4 + P10^2 + 3*P10^4)*P20^4 + (3 + P10^2)*P20^6)*(sL/M1^2-sL0/M10^2))/H0 +...
            ((P10^2 + P20^2)*((P10^8 + P10^6*(13 - 4*P20^2) - 6*P20^2*(-1 + P20^2)^2 + P10^4*(-32 + 46*P20^2 - 11*P20^4) + 3*P10^2*(6 - 12*P20^2 + 9*P20^4 - 2*P20^6))*(1/M1-1/M10) +...
            P10*(17*P10^6 - 20*P20^2 + 35*P20^4 - 12*P20^6 + P10^4*(-37 + 22*P20^2) + P10^2*(20 - 2*P20^2 - 7*P20^4))*(sL/M1-sL0/M10)))/H0^2));
        
        I2c2s3=(1/(2*(P10^2 + P20^2)^4))*(6*DL*(P10^4 - 6*P10^2*P20^2 + P20^4) -...
            2*(2*P10^10 - P10^8*(11 + 5*P20^2) + P10^6*(15 + 46*P20^2 - 25*P20^4) + (-1 + P20)*P20^4*(1 + P20)*(6 - 9*P20^2 + 2*P20^4) + P10^2*P20^2*(36 - 75*P20^2 + 46*P20^4 - 5*P20^6) - P10^4*(6 + 75*P20^2 - 114*P20^4 + 25*P20^6))*K1/H5 +...
            2*P10*(P10^2 - 3*P20^2)*(P10^2 + P20^2)*(cL-cL0) + 24*P10*P20*(-P10^2 + P20^2)*N1 - 2*P20*(-3*P10^4 - 2*P10^2*P20^2 + P20^4)*(sL-sL0) -...
            (P10^2 + P20^2)/(P20*H0^2)*(P10*(P10^6*(5 - 3*P20^2) + P10^4*(-11 + 9*P20^2 - 2*P20^4) + (-1 + P20)*P20^2*(1 + P20)*(18 - 23*P20^2 + 4*P20^4) + P10^2*(6 + 14*P20^2 - 23*P20^4 + 5*P20^6))*(1/M1-1/M10) +...
            (4*P10^8 + 5*P20^4 - 9*P20^6 + 4*P20^8 - P10^6*(9 + 13*P20^2) + P10^4*(5 + 45*P20^2 - 34*P20^4) + P10^2*P20^2*(-30 + 45*P20^2 - 13*P20^4))*(sL/M1-sL0/M10)) +...
            (P10^2 + P20^2)/(P20*H0)*(P10*(-1 + P20^2)*(-P10^4 - 3*P20^2 + 2*P20^4 + P10^2*(1 + P20^2))*(1/M1^2-1/M10^2) +...
            (-P20^4 + P20^6 + P10^6*(1 + P20^2) + P10^2*P20^2*(6 - 5*P20^2 + P20^4) + P10^4*(-1 - 5*P20^2 + 2*P20^4))*(sL/M1^2-sL0/M10^2)));
        
        I1c3s3=(1/(2*(P10^2 + P20^2)^4))*(24*DL*P10*P20*(-P10^2 + P20^2) +...
            6*P10*P20*(2*P10^8 + 8*P20^2 - 20*P20^4 + 15*P20^6 - 3*P20^8 + 3*P10^6*(-5 + P20^2) + P10^2*(-8 + 15*P20^4 - 7*P20^6) + P10^4*(20 - 3*P20^2*(5 + P20^2)))*K1/H5 +...
            2*P20*(-3*P10^4 - 2*P10^2*P20^2 + P20^4)*(cL-cL0) - 6*(P10^4 - 6*P10^2*P20^2 + P20^4)*N1 + 2*P10*(P10^2 - 3*P20^2)*(P10^2 + P20^2)*(sL-sL0) +...
            (P10^2 + P20^2)/H0^2*((P10^6*(9 - 5*P20^2) + 2*(-3 + P20^2)*(P20 - P20^3)^2 + P10^4*(-30 + 34*P20^2 - 8*P20^4) - P10^2*(-18 + 32*P20^2 - 15*P20^4 + P20^6))*(1/M1-1/M10) +...
            P10*(12*P10^6 - 20*P20^2 + 37*P20^4 - 17*P20^6 + 7*P10^4*(-5 + P20^2) + 2*P10^2*(10 + P20^2 - 11*P20^4))*(sL/M1-sL0/M10)) +...
            ((-1 + P20^2)*(P10^2 + P20^2)*(2*P10^4 + P20^2 - P20^4 + P10^2*(-3 + P20^2))*(1/M1^2-1/M10^2) -...
            P10*(4*P20^4 - 5*P20^6 + P20^8 + P10^6*(3 + P20^2) + P10^2*P20^4*(-7 + 3*P20^2) + P10^4*(-4 + P20^2 + 3*P20^4))*(sL/M1^2-sL0/M10^2))/H0);
        
        I4s3=(1/(2*(P10^2 + P20^2)^4))*(-6*DL*(P10^4 - 6*P10^2*P20^2 + P20^4) -...
            6*(P10^2*P20^2*(-12 + P20^2)*(-1 + P20^2)^2 - P20^4*(-2 + P20^2)*(-1 + P20^2)^2 + 4*P10^8*(1 + P20^2) + P10^6*(-5 - 14*P20^2 + 11*P20^4) + P10^4*(2 + 25*P20^2 - 36*P20^4 + 9*P20^6))*K1/H5 -...
            2*P10*(P10^2 - 3*P20^2)*(P10^2 + P20^2)*(cL-cL0) + 24*P10*(P10 - P20)*P20*(P10 + P20)*N1 + 2*P20*(-3*P10^4 - 2*P10^2*P20^2 + P20^4)*(sL-sL0) +...
            (P10^2 + P20^2)/(P20*H0)*((-P10)*(-1 + P20^2)*(P10^2 + 3*(-1 + P10^2)*P20^2 + 3*P20^4)*(1/M1^2-1/M10^2) +...
            (P20^4 - 2*P20^6 + P20^8 + 2*P10^2*P20^2*(-3 + 2*P20^2 + P20^4) + P10^4*(1 + 6*P20^2 + P20^4))*(sL/M1^2-sL0/M10^2)) +...
            (P10^2 + P20^2)/(P20*H0^2)*(P10*((-18 + 7*P20^2)*(P20 - P20^3)^2 + P10^4*(-9 - 6*P20^2 + 7*P20^4) + 2*P10^2*(3 + 9*P20^2 - 19*P20^4 + 7*P20^6))*(1/M1-1/M10) +...
            (5*P20^4*(-1 + P20^2)^2 - 8*P10^6*(1 + 3*P20^2) + P10^4*(5 + 46*P20^2 - 43*P20^4) - 2*P10^2*P20^2*(15 - 22*P20^2 + 7*P20^4))*(sL/M1-sL0/M10)));
    else
        Icc3   = 0;
        Ics3   = 0;
        Iss3   = 0;
        I3c3   = 0;
        I2c1s3 = 0;
        I1c2s3 = 0;
        I3s3   = 0;
        I4c3   = 0;
        I3c1s3 = 0;
        I2c2s3 = 0;
        I1c3s3 = 0;
        I4s3   = 0;
    end
    
    if t_flag
        I11=-(2*K1/H1);
        
        Ia2=-(1/(2*(-1 + P20)*H3))*(...
            2*(-1 + P20)*(K^2-K0^2) -...
            (P10^2 + (-1 + P20)*P20)*(cos(2*K)-cos(2*K0)) -...
            P10*H1*(sin(2*K)-sin(2*K0)) +...
            2*(P10*H1*(K*cos(2*K)-K0*cos(2*K0)) - (P10^2 + (-1 + P20)*P20)*(K*sin(2*K)-K0*sin(2*K0))));
    else
        I11=0;
        Ia2=0;
    end
end

I=[[IJc1;  IJs1];...
    [IJc2; IJc1s1; IJs2];...
    [IJc3; IJc2s1; IJc1s2; IJs3];...
    [IJc4; IJc3s1; IJc2s2; IJc1s3; IJs4];...
    [IJc5; IJc4s1; IJc3s2; IJc2s3; IJc1s4; IJs5];... % These terms might be neglected..
    [I11;  I12;    I13;    Ic2;    Is2;    Ic3;    Is3;  Ia2];
    [Icc3; Ics3;   Iss3;   I3c3;   I2c1s3; I1c2s3; I3s3; I4c3; I3c1s3; I2c2s3; I1c3s3; I4s3]];

return